<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <style>
      #map {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
      /*Legend specific*/
      .legend {
        padding: 6px 4px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        line-height: 18px;
        color: #555;
      }

      select {
            -webkit-appearance: auto;
            -moz-appearance: auto;
            appearance: auto;
            text-align-last:center;
            text-align: center;
      }

      .legend h4 {
        text-align: center;
        font-size: 16px;
        margin: 2px 12px 8px;
        color: #777;
      }

      .legend span {
        position: relative;
        bottom: 3px;
      }

      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin: 0 8px 0 0;
        opacity: 0.7;
      }

      .legend i.icon {
        background-size: 18px;
        background-color: rgba(255, 255, 255, 1);
      }
    </style>
  </head>
  
  <body>
    <div id="map"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" type="text/css">
    <script src="https://unpkg.com/leaflet-gesture-handling"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => { 
        //define scaler for data
        var scaler = 10;

        // initalize leaflet map and set some prefs
        const map = L.map('map', {
          preferCanvas: true, 
          gestureHandling: true, 
          attributionControl: false
        }).setView(new L.LatLng(45, -110), 6);
        
        map.createPane('SNOTEL');
        map.getPane('SNOTEL').style.zIndex = 650;

        //set min zoom
        map.options.minZoom = 5;
      
        //add MCO attribution
        map.addControl(L.control.attribution({
            position: 'bottomright',
            prefix: '<a href="https://climate.umt.edu/" target="_blank">MCO</a>'
        }));

        // add OpenStreetMap basemap
        L.tileLayer('https://api.maptiler.com/tiles/hillshades/{z}/{x}/{y}.png?key=KZO7rAv96Alr8UVUrd4a', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        //define legend control
        var legend = L.control({ position: "bottomleft" });
        var USDMlegend = L.control({ position: "bottomright" });

        //define active layers layer group to populate as cogs are added
        var activeLayers = new L.LayerGroup();
        var snowLayers = new L.LayerGroup();

        // define selector
        var selector = L.control({
            position: 'topleft'
        })

        // create DOM object
        selector.onAdd = function(map) {
            var div = L.DomUtil.create('select');
            return div
        }

        //add to map
        selector.addTo(map);

        // names the variables
        $('select').empty()

        //define variables in dropdown
        var variables = ['Choose a Variable','horizontal-line',
                        'SPI', 'SPEI', 'EDDI', 'horizontal-line', 
                        'Precipitation Percentiles','Temperature Percentiles', 'horizontal-line',
                        'Snowpack', 'horizontal-line',
                        'SMAP Soil Moisture', 'horizontal-line',
                        'GRACE Groundwater', 'horizontal-line',
                        'NDVI Anomaly','horizontal-line']

        //populate selector
        variables.forEach(function(item) {
          if(item === 'horizontal-line'){
            $('select')
                .append($('<hr>', {
                        class: 'divider'
                    }));
          }
          else {
            $('select')
                .append($('<option>', {
                        value: item
                    })
                    .text(item));
          }
        })

        //define layer control for baselayers (will be removed with selector change)
        var layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
        
        //define layer control for flatgeobufs (will not be removed with selector change)
        var fgbLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map)
        var snowFGBLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false});

        // define COG load function 
        function addCOG(url, name_, display = false, breaks, scale) { 
          var layer_name = name_
          fetch(url)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => {
            parseGeoraster(arrayBuffer).then(georaster => {
              //define some constants from the georaster package
              const min = georaster.mins[0];
              const max = georaster.maxs[0];
              const range = georaster.ranges[0];

              // define COG georaster
              var layer = new GeoRasterLayer({
                  georaster: georaster,
                  opacity: 0.9,
                  updateWhenZooming: false,
                  pixelValuesToColorFn: function(pixelValues) {
                    var pixelValue = pixelValues[0]; // there's just one band in this raster
                    // if there's zero wind, don't return a color
                    if (pixelValue === -32767) return null;
                    var color = scale(pixelValue).hex();
                    return color;
                  },
                  resolution: 256
              });
              //add layers to layerControl
              layerControl.addBaseLayer(layer, layer_name)
              //display layer if ture
              if(display == true){
                layer.addTo(map)
              }
              //add to active layer array for removal
              activeLayers.addLayer(layer)
            });
          });
        }

        // define function to parse time file
        function loadFile(filePath) {
          var result = null;
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("GET", filePath, false);
          xmlhttp.send();
          if (xmlhttp.status==200) {
            result = xmlhttp.responseText;
          }
          return result;
        }

        // This will be run when L.geoJSON creates the point layer from the GeoJSON data.
        function createCircleMarker( feature, latlng ){
          // Change the values of these options to change the symbol's appearance
          let options = {
            radius: 8,
            fillColor: feature.properties.fillColor,
            color: "black",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }
          return L.circleMarker( latlng, options );
        }

        //define function to add flatgeobuf files
        async function addFGB(fgb_url, fgb_name, weight, display = false, popup_property){
          //define tempGroup 
          var tempGroup = [];    
          //redefine popup property    
          var popup_property_ = popup_property
          //async wait for flatgeobuf fetch
          const response = await fetch(fgb_url)
          //loop each feature
          for await (const f of flatgeobuf.deserialize(response.body))
            //if the layer is USDM then add it differently (fill colors etc)
            if(fgb_name === 'USDM'){
              tempGroup.push(
                L.geoJSON(f, {color: 'black', fillOpacity: 0.5, weight: weight, fillColor: f.properties.fillColor})
              );
            } 
            else if (fgb_name === 'Hypsome-SWE'){
              tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight})
              .bindTooltip(f.properties[popup_property_])
              .bindPopup("<img src='https://data.climate.umt.edu/drought-indicators/plots/hypsome-swe-"+
                         f.properties.HUC8+".png' height='500' width='500' loading='lazy'/>",
                         {
                            maxWidth: "auto"
                          }));
            } 
            else if (fgb_name === 'SNOTEL SWE') {
              tempGroup.push(
                L.geoJSON(f, {pointToLayer: createCircleMarker})
                .bindPopup("<img src='https://data.climate.umt.edu/drought-indicators/plots/snotel_plot_"+
                         f.properties.site_id+".png' height='400' width='450' loading='lazy'/>",
                         {
                            maxWidth: "auto"
                          })
              );
            }
            else {
              //if there is a popop property to bind, do it.
              if(popup_property_ == null){
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}));
              } else {
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}).bindTooltip(f.properties[popup_property_]));
              }
            }
            //if adding hypsome-swe, we need to name it differently for cleanUp fun
            if(fgb_name === 'Hypsome-SWE'){
              //define tempGroupLayer feature group to add to layer control
              var hypsomeSWE = L.featureGroup(tempGroup);
              hypsomeSWE._leaflet_id = 'Hypsome-SWE'
              //define to sessionStorage
              sessionStorage.hypsomeSWE = hypsomeSWE;
              //add group to the fgb laer control 
              snowFGBLayerControl.addOverlay(hypsomeSWE , fgb_name); 
              snowLayers.addLayer(hypsomeSWE)
              //display if display param == true on initial load
              if(display == true){
                hypsomeSWE.addTo(map)
              }
            } else if (fgb_name === 'SNOTEL SWE'){
              //define tempGroupLayer feature group to add to layer control
              var snotelSWE = L.featureGroup(tempGroup);
              //define to sessionStorage
              sessionStorage.snotelSWE = snotelSWE;
              //add group to the fgb layer control 
              snowFGBLayerControl.addOverlay(snotelSWE , fgb_name); 
              snowLayers.addLayer(snotelSWE)
            } else {
              //define tempGroupLayer feature group to add to layer control
            var tempGroupLayer = L.featureGroup(tempGroup);
            //add group to the fgb laer control 
            fgbLayerControl.addOverlay(tempGroupLayer , fgb_name); 
            //add it to the snow control too for later (only used when snow selector is active)
            snowFGBLayerControl.addOverlay(tempGroupLayer , fgb_name); 
            //display if display param == true on initial load
              if(display == true){
                tempGroupLayer.addTo(map)
              }
            }
        };
        
        //define exists function
        function exists(data){
          data !== null && data !== undefined
        }

        var cleanUp = function(){
          //remove active layers from map
          activeLayers.eachLayer(function(layer) { map.removeLayer(layer);});
          //remove hypsomeswe from map if loaded
          snowLayers.eachLayer(function(layer) { map.removeLayer(layer);});
          //remove old layer control
          map.removeControl(layerControl);
          //remove old legend
          map.removeControl(legend);
        }

        var updateFgbControls = function(){
          //remove old FGB control 
          map.removeControl(snowFGBLayerControl);
          map.addControl(fgbLayerControl);
        }

        // add FGBs to map (before selector change!!)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/states.fgb', fgb_name = 'States', weight = 3, display = true, popup_property = null);
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/watersheds.fgb', fgb_name = 'Watersheds', weight = 1, display = false, popup_property = 'NAME');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/counties.fgb', fgb_name = 'Counties', weight = 1, display = false, popup_property = 'COUNTY');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/tribal.fgb', fgb_name = 'Tribal Lands', weight = 1, display = false, popup_property = 'NAME');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_usdm.fgb', fgb_name = 'USDM', weight = 1, display = false, popup_property = 'DM');
        //add hypsome-swe (only added to snow control)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/watersheds.fgb', fgb_name = 'Hypsome-SWE', weight = 1, display = false, popup_property = 'NAME');
        //add SNOTEL SWE (only added to snow control)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_snotel.fgb', fgb_name = 'SNOTEL SWE', weight = 1, display = false, popup_property = 'NAME');

        //build USDM legend
        USDMlegend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>U.S. Drought Monitor<br>(USDM)<br>"+loadFile('https://data.climate.umt.edu/drought-indicators/fgb/usdm_time.txt')+"</h4>";
              div.innerHTML += '<i style="background: #FFFF00"></i><span>D0 (Abnormally Dry)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>D1 (Moderate Drought)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>D2 (Severe Drought)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>D3 (Extreme Drought)</span><br>';
              div.innerHTML += '<i style="background: #730000"></i><span>D4 (Exceptional Drought)</span><br>';
              return div;
            };
        //add to map
        USDMlegend.addTo(map);

        //function to call when selector is choosen
        $('select').change(function() {
          if(this.value === 'SPI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'SPI'
            var variable_lower = 'spi'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spi/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date SPI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'SPEI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'SPEI'
            var variable_lower = 'spei'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spei/time.txt')
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPEI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date SPEI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'EDDI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'EDDI'
            var variable_lower = 'eddi'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/eddi/time.txt')
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83'].reverse()).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day EDDI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date EDDI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>>2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>1.6 - 1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>1.3 - 0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>0.8 - 0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>-0.5 - -0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>-0.8 - -1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>-1.3 - -1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>-1.6 - -2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span><-2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Precipitation Percentiles'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'Precipitation<br>Percentiles'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/precipitation/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_15.tif", 
              "(a) 15 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_30.tif", 
              "(b) 30 Day Percentile", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_60.tif", 
              "(c) 60 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_90.tif", 
              "(d) 90 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_180.tif", 
              "(e) 180 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_365.tif", 
              "(f) 1 Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_water_year.tif", 
              "(h) Water Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_year_to_date.tif", 
              "(i) Year to Date Percentile", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>0 - 2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 5 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>5 - 10 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>10 - 20 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>20 - 30 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>70 - 80</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>80 - 90</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>90 - 95</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>95 - 98</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>98 - 100</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Temperature Percentiles'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'Temperature<br>Percentiles'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/temperature/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83'].reverse()).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_15.tif", 
              "(a) 15 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_30.tif", 
              "(b) 30 Day Percentile", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_60.tif", 
              "(c) 60 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_90.tif", 
              "(d) 90 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_180.tif", 
              "(e) 180 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_365.tif", 
              "(f) 1 Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_water_year.tif", 
              "(h) Water Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_year_to_date.tif", 
              "(i) Year to Date Percentile", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #303B83"></i><span>0 - 2</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>2 - 5</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>5 - 10</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>10 - 20</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>20 - 30</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>70 - 80 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>80 - 90 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>90 - 95 (D2)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>95 - 98 (D3)</span><br>';
              div.innerHTML += '<i style="background: #730000"></i><span>98 - 100 (D4)</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Snowpack'){
            //remove old FGB controls (special case, otherwise use updateFgbControls())
            map.removeControl(fgbLayerControl);
            map.addControl(snowFGBLayerControl);
            //add snow controls
            map.addControl(snowFGBLayerControl);
            //define variable of interest
            var variable = 'Standardized<br>Snow Water<br>Equivalent (SWE)'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/snodas/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_snodas_swe_standardized_4km.tif", 
              "(a) Standardized SWE", display = true, breaks = breaks, scale = scale)
            //add hypsome-swe to the map
            map.addLayer(snowLayers._layers['Hypsome-SWE']);
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'SMAP Soil Moisture'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'SMAP<br>Soil Moisture'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/smap/time.txt')
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_smap_anom.tif", 
              "(a) SMAP Soil Moisture", display = true, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'GRACE Groundwater'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'GRACE<br>Groundwater'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/grace/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current-grace-groundwater-drought.tif", 
              "(a) GRACE Groundwater", display = true, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>0 - 2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 5 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>5 - 10 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>10 - 20 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>20 - 30 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>70 - 80</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>80 - 90</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>90 - 95</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>95 - 98</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>98 - 100</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'NDVI Anomaly'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'NDVI Anomaly'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/ndvi/anom/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_7.tif", 
              "(a) 7 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_15.tif", 
              "(b) 15 Day NDVI Anomaly", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_30.tif", 
              "(c) 30 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_60.tif", 
              "(d) 60 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_90.tif", 
              "(e) 90 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
        });
      });
    </script>
  </body>
</html>
