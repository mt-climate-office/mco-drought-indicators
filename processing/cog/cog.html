<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"/>
    <style>
      #map {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
      /*Legend specific*/
      .legend {
        padding: 6px 4px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        line-height: 18px;
        color: #555;
      }

      select {
            -webkit-appearance: auto;
            -moz-appearance: auto;
            appearance: auto;
      }

      .legend h4 {
        text-align: center;
        font-size: 16px;
        margin: 2px 12px 8px;
        color: #777;
      }

      .legend span {
        position: relative;
        bottom: 3px;
      }

      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin: 0 8px 0 0;
        opacity: 0.7;
      }

      .legend i.icon {
        background-size: 18px;
        background-color: rgba(255, 255, 255, 1);
      }
      
    </style>
  </head>
  
  <body>
    <div id="map"></div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" type="text/css">
    <script src="https://unpkg.com/leaflet-gesture-handling"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => { 
        //define scaler for data
        var scaler = 10;

        // initalize leaflet map and set some prefs
        const map = L.map('map', {
          preferCanvas: true, 
          gestureHandling: true, 
          attributionControl: false
        }).setView(new L.LatLng(45, -110), 6);
        
        //set min zoom
        map.options.minZoom = 5;
      
        //add MCO attribution
        map.addControl(L.control.attribution({
            position: 'bottomright',
            prefix: '<a href="https://climate.umt.edu/" target="_blank">MCO</a>'
        }));

        // add OpenStreetMap basemap
        L.tileLayer('https://api.maptiler.com/tiles/hillshades/{z}/{x}/{y}.png?key=KZO7rAv96Alr8UVUrd4a', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        //define legend control
        var legend = L.control({ position: "bottomleft" });

        //define active layers layer group to populate as cogs are added
        var activeLayers = new L.LayerGroup();

        // define selector
        var selector = L.control({
            position: 'topleft'
        })

        // create DOM object
        selector.onAdd = function(map) {
            var div = L.DomUtil.create('select');
            return div
        }

        //add to map
        selector.addTo(map);

        // names the variables
        $('select').empty()

        //define variables in dropdown
        var variables = ['Choose a Variable','SPI', 'SPEI', 'EDDI']

        //populate selector
        variables.forEach(function(item) {
            $('select')
                .append($('<option>', {
                        value: item
                    })
                    .text(item));
        })

        //define layer control for baselayers (will be removed with selector change)
        var layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
        
        //define layer control for flatgeobufs (will not be removed with selector change)
        var fgbLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map)

        // define COG load function 
        function addCOG(url, name_, display = false) { 
          var layer_name = name_
          fetch(url)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => {
            parseGeoraster(arrayBuffer).then(georaster => {
              //define some constants from the georaster package
              const min = georaster.mins[0];
              const max = georaster.maxs[0];
              const range = georaster.ranges[0];
              
              //define breaks
              var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });

              //add chroma scale that matches the USDM
              var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 

              // define COG georaster
              var layer = new GeoRasterLayer({
                  georaster: georaster,
                  opacity: 0.9,
                  updateWhenZooming: false,
                  pixelValuesToColorFn: function(pixelValues) {
                    var pixelValue = pixelValues[0]; // there's just one band in this raster
                    // if there's zero wind, don't return a color
                    if (pixelValue === -32767) return null;
                    var color = scale(pixelValue).hex();
                    return color;
                  },
                  resolution: 256
              });
              //add layers to layerControl
              layerControl.addBaseLayer(layer, layer_name)
              //display layer if ture
              if(display == true){
                layer.addTo(map)
              }
              //add to active layer array for removal
              activeLayers.addLayer(layer)
            });
          });
        }

        // define function to parse time file
        function loadFile(filePath) {
          var result = null;
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("GET", filePath, false);
          xmlhttp.send();
          if (xmlhttp.status==200) {
            result = xmlhttp.responseText;
          }
          return result;
        }

        //define function to add flatgeobuf files
        async function addFGB(fgb_url, fgb_name, weight, display = false, popup_property){
          //define tempGroup 
          var tempGroup = [];    
          //redefine popup property    
          var popup_property_ = popup_property
          //async wait for flatgeobuf fetch
          const response = await fetch(fgb_url)
          //loop each feature
          for await (const f of flatgeobuf.deserialize(response.body))
            //if there is a popop property to bind, do it.
            if(popup_property_ == null){
              tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}));
            } else {
              tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}).bindTooltip(f.properties[popup_property_]));
            }
          //define tempGroupLayer feature group to add to layer control
          var tempGroupLayer = L.featureGroup(tempGroup);
          //add group to the fgb laer control 
          fgbLayerControl.addOverlay(tempGroupLayer , fgb_name); 
          //display if display param == true on initial load
          if(display == true){
            tempGroupLayer.addTo(map)
          }
        };
        
        // add FGBs to map (before selector change!!)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/states.fgb', fgb_name = 'States', weight = 3, display = true, popup_property = null);
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/watersheds.fgb', fgb_name = 'Watersheds', weight = 1, display = false, popup_property = 'NAME');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/counties.fgb', fgb_name = 'Counties', weight = 1, display = false, popup_property = 'COUNTY');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/tribal.fgb', fgb_name = 'Tribal Lands', weight = 1, display = false, popup_property = 'NAME');

        //function to call when selector is choosen
        $('select').change(function() {
          if(this.value === 'SPI'){
            //define variable of interest
            var variable = 'SPI'
            var variable_lower = 'spi'
            //remove active layers from map
            activeLayers.eachLayer(function(layer) { map.removeLayer(layer);});
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //remove old layer control
            map.removeControl(layerControl);
            //remove old legend
            map.removeControl(legend);
            //create new layer control 
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
            //add it to the map
            layerControl.addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spi/time.txt')
            // import and add COGs to map from remote server
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPI", display = true)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(g) 2 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"year_to_date.tif", 
              "(i) Year to Date")
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'SPEI'){
            //define variable of interest
            var variable = 'SPEI'
            var variable_lower = 'spi'
            //remove active layers from map
            activeLayers.eachLayer(function(layer) { map.removeLayer(layer);});
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //remove old layer control
            map.removeControl(layerControl);
            //remove old legend
            map.removeControl(legend);
            //create new layer control 
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
            //add it to the map
            layerControl.addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spi/time.txt')
            // import and add COGs to map from remote server
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPI", display = true)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(g) 2 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"year_to_date.tif", 
              "(i) Year to Date")
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'EDDI'){
            //define variable of interest
            var variable = 'EDDI'
            var variable_lower = 'spi'
            //remove active layers from map
            activeLayers.eachLayer(function(layer) { map.removeLayer(layer);});
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //remove old layer control
            map.removeControl(layerControl);
            //remove old legend
            map.removeControl(legend);
            //create new layer control 
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
            //add it to the map
            layerControl.addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spi/time.txt')
            // import and add COGs to map from remote server
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPI", display = true)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(g) 2 Year SPI")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year")
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"year_to_date.tif", 
              "(i) Year to Date")
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
        });
      });
    </script>
  </body>
</html>
