<!DOCTYPE html>
<html>
  <head>
    <title>Drought Dashboard</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149859729-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-149859729-1');
    </script>
    <!-- Import Bootstrap Scripts and CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Define Custom CSS styling -->
    <style>
      #map {
        bottom: 0px;
        left: 0px;
        position: relative;
        right: 0px;
        top: 40px;
        height: 800px;
        width: 98%;
        border: 3px solid #000000;
        margin-left:auto;
        margin-right:auto;
      }

      footer {
        text-align: center;
        background-color: rgba(255, 255, 255, 0.199);
        color: rgb(0, 0, 0);
      }

      .parent{
        height:200px;
        text-align:center;
        display:table;
        width:100%;
        margin-top: 20px;
      }

      .parent .child{
        display:table-cell;
        vertical-align:middle;
        width:100%;
        height:100%;
      }

      .legend {
        padding: 6px 4px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        line-height: 18px;
        color: #555;
      }

      .pointLegend {
        padding: 6px 4px;
        font: 14px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        line-height: 18px;
        color: #555;
      }

      select {
            -webkit-appearance: auto;
            -moz-appearance: auto;
            appearance: auto;
            text-align-last:center;
            text-align: center;
      }

      .legend h4 {
        text-align: center;
        font-size: 16px;
        margin: 0px 0px 12px;
        color: #777;
      }

      .pointLegend h4 {
        text-align: center;
        font-size: 16px;
        margin: 0px 0px -6px;
        color: #777;
      }

      .legend span {
        position: relative;
        bottom: 3px;
      }

      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin: 0 8px 0 0;
        opacity: 0.7;
      }

      .pointLegend i {
        width: 18px;
        height: 18px;
        float: left;
        margin: 0 8px 0 0;
        opacity: 0.7;
      }

      .legend i.icon {
        background-size: 18px;
        background-color: rgba(255, 255, 255, 1);
      }

      .circle {
      float: left;
      border: 1px solid #222;
      border-radius: 50%;
      }

      .pointLegend .colorcircle {
      border-radius: 50%;
      width: 15px;
      height: 15px;
      margin-top: 0px;
      }
      .pointLegend .circlepadding {
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.85);
      }

      .pointLegend i.icon {
        background-size: 18px;
        background-color: rgba(255, 255, 255, 1);
      }

      .navbar-brand{
        margin-left: 20px;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande',
        'Lucida Sans', Arial, sans-serif;
      }
      
      .select2 {
        width:300px!important;
        z-index: 99999 !important;
        margin-top: 10px;
        margin-bottom: 10px;
        margin-left: 10px;
        font-size:14px;
      }

      .select2-results__options{
        font-size:12px !important;
      }  

      .leaflet-left {
          padding-top: 40px;
      }

      #addSoilMoisturePoints {
        font-size:16px !important;
        position: absolute;
        top: 110px;
        right: 280px;
        padding: 10px;
        z-index: 800;
        height: 60px;
      }

      .rangeslider {
        position: absolute;
        top: 111px;
        width: 200px;
        height: 60px;
        right: 70px;
        padding: 10px;
        z-index: 800;
        border: 1px solid rgb(0, 0, 0);
        color: rgb(0, 0, 0);
        background-color: #EFEFEF;
        text-align: center;
      }

      .rangesliderUSDM {
        font-size:16px !important;
        position: absolute;
        top: 625px;
        width: 195px;
        height: 60px;
        right: 30px;
        padding: 10px;
        z-index: 800;
        border: 1px solid rgb(0, 0, 0);
        color: rgb(0, 0, 0);
        background-color: #EFEFEF;
        text-align: center;
        display:none;
      }

      .toGrey img {
          filter: grayscale(1);
      }

    </style>
  </head>
  <body>
    <!-- Build Nav Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="">UMRB Drought Indicators Dashboard</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse " id="navbarNavDropdown">
        <ul class="navbar-nav navbar-right">
          <li class="nav-item">
            <a class="nav-link" href="https://fcfc-mesonet.cfc.umt.edu/dash/">MT Mesonet</a>
          </li>
          <!-- Add documentation soon -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Drought Impacts
            </a>
            <div class="dropdown-menu position-absolute" aria-labelledby="navbarDropdownMenuLink">
              <h6 class="dropdown-header">MT Drought Impacts Reporter</h6> 
              <a class="dropdown-item" href="http://nris.mt.gov/droughtsurvey">Make a Report</a>
              <a class="dropdown-item" href="http://nris.mt.gov/droughtimpacts">See Current Reports</a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Documentation
            </a>
            <div class="dropdown-menu position-absolute" aria-labelledby="navbarDropdownMenuLink">
              <h6 class="dropdown-header">Dashboard Documentation</h6> 
              <a class="dropdown-item" href="#">Data and Metrics (Coming Soon!)</a>
              <div class="dropdown-divider"></div>
              <!-- <h6 class="dropdown-header">General</h6> -->
              <a class="dropdown-item" href="https://climate.umt.edu/" target="_blank">Montana Climate Office (About Us)</a>
            </div>
          </li>
          </ul>
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link ml-auto" href="https://github.com/mt-climate-office">MCO GitHub</a>
            </li>
        </ul>
      </div>
    </nav>
    <!-- import remote scripts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/chroma-js"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.min.js"></script> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://unpkg.com/flatgeobuf@3.22.0/dist/flatgeobuf-geojson.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css" type="text/css">
    <script src="https://unpkg.com/leaflet-gesture-handling"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://unpkg.com/leaflet.tilelayer.fallback@1.0.4/dist/leaflet.tilelayer.fallback-src.js"></script>
    <div class="rangeslider">
      <label id= "sliderLabel" for="slider">Map Opacity</label>
      <input id="opacitySlide" type="range" class="form-range" min="0" max="1" step="0.01" value="0.9" fill="white">
    </div>
    <div class="rangesliderUSDM">
      <label id= "sliderLabelUSDM" for="slider">USDM Opacity</label>
      <input id="opacitySlideUSDM" type="range" class="form-range" min="0" max="1" step="0.01" value="0.9" fill="white">
    </div>
    <div id="map"></div>
    <input type="button" id="addSoilMoisturePoints" value='Add Soil Moisture Stations' class="btnStyle span3" />
    <script>
      //Map script! 
      document.addEventListener("DOMContentLoaded", async () => { 
        //define scaler for data
        var scaler = 10;

        // initalize leaflet map and set some prefs
        const map = L.map('map', {
          preferCanvas: true, 
          gestureHandling: true, 
          attributionControl: false,
          inertia: false,
          noMoveStart: true,
          animate: false,
          zoomAnimation: true,
          zoomAnimationThreshold: 3,
          fadeAnimation: true,
          markerZoomAnimation:false,
          zoomDelta: 0.5,
          zoomSnap: 0,
          zoomControl: false
        }).setView(new L.LatLng(45, -111), 6);
        
        map.createPane('SNOTEL');
        map.getPane('SNOTEL').style.zIndex = 650;
        map.createPane('labels');
        map.getPane('labels').style.zIndex = 651;
      
        //define layer control for baselayers (will be removed with selector change)
        var layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false})
        
        //define layer control for flatgeobufs (will not be removed with selector change)
        var fgbLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map)
        var snowFGBLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false});
        var soilMoistureFGBLayerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false});

        //set min zoom
        map.options.minZoom = 5;

        L.control.zoom({
            position:'topright'
        }).addTo(map);

        //add attribution
        map.addControl(L.control.attribution({
            position: 'bottomright',
            prefix: '<a href="https://climate.umt.edu/" target="_blank">MCO</a>'
        }));

        //base map
        //L.tileLayer.fallback('https://tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=2a290c2900324a42bf8588e8687eb40d', {className: 'toGrey'}).addTo(map)
        //map.attributionControl.addAttribution('<a href="https://thunderforest.com" target="_blank">Thunderforest</a>');
        //map.attributionControl.addAttribution('<a href="https://openstreetmap.org/copyright" target="_blank">OSM contributors</a>');
        
        L.tileLayer.fallback('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {className: 'toGrey'}).addTo(map)
        map.attributionControl.addAttribution('<a href="https://www.esri.com/" target="_blank">Tiles &copy; ESRI</a>');

        // outdated base map layers and vectors
         //$.getJSON("https://tile.thunderforest.com/thunderforest.transport-v2.json?apikey=2a290c2900324a42bf8588e8687eb40d",function(data){
        //   L.geoJson(data).addTo(newMap);
        //});
        //L.geoJSON('https://tile.thunderforest.com/thunderforest.transport-v2.json?apikey=2a290c2900324a42bf8588e8687eb40d').addTo(map);
        //L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=2a290c2900324a42bf8588e8687eb40d').addTo(map);
        //add background - slows down loads...
        //L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-background/{z}/{x}/{y}.png').addTo(map);
        //add stamen toner labels and lines
        //var labels = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {pane: 'labels'}).addTo(map);
        //L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}.png').addTo(map);
        //L.tileLayer('https://api.maptiler.com/tiles/hillshades/{z}/{x}/{y}.png?key=94vjatYf0fxNnMGBpIwo').addTo(map);
        //add labels to the control layer
        //fgbLayerControl.addOverlay(labels, 'Map Labels')
        //snowFGBLayerControl.addOverlay(labels, 'Map Labels')
        
        //define default legend controls
        var legend = L.control({ position: "bottomleft" });
        var USDMlegend = L.control({ position: "bottomright" });
        var topofire_legend = L.control({ position: "bottomleft" });
        var smap_legend = L.control({ position: "bottomleft" });

        //define active layers layer group to populate as cogs are added
        var activeLayers = new L.LayerGroup();
        var snowLayers = new L.LayerGroup();
        var USDMLayer = new L.LayerGroup();
        var soilMoistureLayers = new L.LayerGroup();

        // define selector
        var selector = L.control({
            position: 'topleft'
        })

        // create DOM object
        selector.onAdd = function(map) {
            var div = L.DomUtil.create('select');
            return div
        }

        //add to map
        selector.addTo(map);

        // names the variables
        $('select').empty()

        // define selecter data
        var selectData = [{
          id:"",
          text: ""
        },
        {
          text:'Drought Metrics',
          children: [{
            id: 'SPI',
            text: 'SPI (Standardized Precipitation Index)',
          },
          {
            id: 'SPEI',
            text: 'SPEI (Standardized Precipitation Evapotranspiration Index)'
          },
          {
            id: 'EDDI',
            text: 'EDDI (Evaporative Demand Drought Index)'
          }
        ]
        },
        {
          text:'Soil Moisture',
          children: [{
            id: 'Soil Moisture',
            text: 'Soil Moisture (Modelled)',
          }
        ]
        },
        {
          text:'Meteorology',
          children: [{
            id: 'Precipitation Percentiles',
            text: 'Precipitation Percentiles',
          },
          {
            id: 'Precipitation Percent of Normal',
            text: 'Precipitation Percent of Normal',
          },
          {
            id: 'Temperature Percentiles',
            text: 'Temperature Percentiles (Daily Maximum Temperature)'
          },
        ]
        },
        {
          text:'Snow',
          children: [{
            id: 'Snowpack',
            text: 'Snow Water Equivalent and Hypsome-SWE',
          }
        ]
        },
        {
          text:'Groundwater',
          children: [{
            id: 'GRACE Groundwater',
            text: 'GRACE Groundwater Percentile [NASA]',
          }
        ]
        },
        {
          text:'Vegetation',
          children: [
          {
            id: 'NDVI Anomaly',
            text: 'NDVI (Greeness) Anomaly [NASA]',
          }
        ]
        }]

        $(document).ready(function() {
          $('select').select2({placeholder: 'Choose a Variable', data: selectData});
        });
   
        function setParent(el, newParent){
            newParent.appendChild(el);
        }

        setParent(selector.getContainer(), document.getElementById('map'));
      
        // define COG load function 
        function addCOG(url, name_, display = false, breaks, scale) { 
          var layer_name = name_
          fetch(url)
          .then(response => response.arrayBuffer())
          .then(arrayBuffer => {
            parseGeoraster(arrayBuffer).then(georaster => {
              //define some constants from the georaster package
              const min = georaster.mins[0];
              const max = georaster.maxs[0];
              const range = georaster.ranges[0];

              // define COG georaster
              var layer = new GeoRasterLayer({
                  georaster: georaster,
                  opacity: document.getElementById("opacitySlide").value,
                  updateWhenZooming: false,
                  pixelValuesToColorFn: function(pixelValues) {
                    var pixelValue = pixelValues[0]; // there's just one band in this raster
                    // if there's zero wind, don't return a color
                    if (pixelValue === -32767) return null;
                    var color = scale(pixelValue).hex();
                    return color;
                  },
                  resolution: 256
              });
              layer.name = name_
              //add layers to layerControl
              layerControl.addBaseLayer(layer, layer_name)
              //display layer if ture
              if(display == true){
                layer.addTo(map)
              }
              //add to active layer array for removal
              activeLayers.addLayer(layer)
            });
          });
        }

        // define function to parse time file
        function loadFile(filePath) {
          var result = null;
          var xmlhttp = new XMLHttpRequest();
          xmlhttp.open("GET", filePath, false);
          xmlhttp.send();
          if (xmlhttp.status==200) {
            result = xmlhttp.responseText;
          }
          return result;
        }

        // This will be run when L.geoJSON creates the point layer from the GeoJSON data.
        function createCircleMarker( feature, latlng ){
          // Change the values of these options to change the symbol's appearance
          let options = {
            radius: 8,
            fillColor: feature.properties.fillColor,
            color: "black",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          }
          return L.circleMarker( latlng, options );
        }

        //define function to add flatgeobuf files
        async function addFGB(fgb_url, fgb_name, weight, display = false, popup_property, depth = null){
          //define tempGroup 
          var tempGroup = [];   
          var tempGroupHypsomeSWE = []; 
          var tempGroupSoilMoisture = [];
          //redefine popup property    
          var popup_property_ = popup_property
          //async wait for flatgeobuf fetch
          const response = await fetch(fgb_url)
          //loop each feature
          for await (const f of flatgeobuf.deserialize(response.body))
            //if the layer is USDM then add it differently (fill colors etc)
            if(fgb_name === 'USDM'){
              tempGroup.push(
                L.geoJSON(f, {color: 'black', fillOpacity: 0.5, weight: weight, fillColor: f.properties.fillColor})
              );
              var USDM = L.featureGroup(tempGroup);
              USDMLayer.addLayer(USDM)
            } 
            //both hypsomeSWE and watersheds use Watershed FGB, no need to load twice
            else if (fgb_name === 'Watersheds'){
              //first HypsomeSWE
              tempGroupHypsomeSWE.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight})
              .bindTooltip(f.properties[popup_property_])
              .bindPopup("<img src='https://data.climate.umt.edu/drought-indicators/plots/hypsome-swe-"+
                         f.properties.HUC8+".png' height='500px' width='500px' loading='lazy'/>",
                         {
                            maxWidth: "auto",
                            popupAnchor: [0,0]
                          }));
              //Now just regular watersheds without the popup
              //if there is a popop property to bind, do it.
              if(popup_property_ == null){
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}));
              } else {
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}).bindTooltip(f.properties[popup_property_]));
              }     
            } 
            else if (fgb_name === 'SNOTEL SWE') {
              tempGroup.push(
                L.geoJSON(f, {pointToLayer: createCircleMarker})
                .bindPopup("<img src='https://data.climate.umt.edu/drought-indicators/plots/snotel_plot_"+
                         f.properties.site_id+".png' height='300' width='400' loading='lazy'/>",
                         {
                            maxWidth: "auto"
                          })
              );
            }
            else if (fgb_name.includes('Mesonet Soil Moisture')) {
              tempGroup.push(
                L.geoJSON(f, {pointToLayer: createCircleMarker})
                .bindPopup("<img src='https://data.climate.umt.edu/drought-indicators/plots/"+
                         f.properties.station_key+"_"+f.properties.name+"_current.png' height='350' width='350' loading='lazy'/>",
                         {
                            maxWidth: "auto"
                          })
              );
            }
            else {
              //if there is a popop property to bind, do it.
              if(popup_property_ == null){
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}));
              } else {
                tempGroup.push(L.geoJSON(f, {color: 'black', fillOpacity: 0, weight: weight}).bindTooltip(f.properties[popup_property_]));
              }
            }
            //if adding hypsome-swe, we need to name it differently for cleanUp fun
            if(fgb_name === 'Watersheds'){
              //define tempGroupLayer feature group to add to layer control
              var hypsomeSWE = L.featureGroup(tempGroupHypsomeSWE);
              hypsomeSWE._leaflet_id = 'Hypsome-SWE'
              //define to sessionStorage
              sessionStorage.hypsomeSWE = hypsomeSWE;
              //add group to the fgb laer control 
              snowFGBLayerControl.addOverlay(hypsomeSWE , 'Hypsome-SWE'); 
              snowLayers.addLayer(hypsomeSWE)
              //display if display param == true on initial load
              if(display == true){
                hypsomeSWE.addTo(map)
              }
              //define tempGroupLayer feature group to add to layer control
              var tempGroupLayer = L.featureGroup(tempGroup);
              //add group to the fgb laer control 
              fgbLayerControl.addOverlay(tempGroupLayer , fgb_name); 
            } else if (fgb_name === 'SNOTEL SWE'){
              //define tempGroupLayer feature group to add to layer control
              var snotelSWE = L.featureGroup(tempGroup);
              snotelSWE._leaflet_id = 'SNOTEL SWE'
              //define to sessionStorage
              sessionStorage.snotelSWE = snotelSWE;
              //add group to the fgb layer control 
              snowFGBLayerControl.addOverlay(snotelSWE , fgb_name); 
              snowLayers.addLayer(snotelSWE)
              if(display == true){
                snowLayers.addTo(map)
              }
            } 
            else if (fgb_name.includes('Soil Moisture')){
              //define tempGroupLayer feature group to add to layer control
              var mesonetVWC = L.featureGroup(tempGroup);
              mesonetVWC._leaflet_id = 'Mesonet VWC'+depth
              //define to sessionStorage
              sessionStorage.mesonetVWC = mesonetVWC;
              //add group to the fgb layer control 
              soilMoistureFGBLayerControl.addBaseLayer(mesonetVWC , fgb_name); 
              soilMoistureLayers.addLayer(mesonetVWC)
              if(display == true){
                mesonetVWC.addTo(map)
              }
            } else {
              //define tempGroupLayer feature group to add to layer control
              var tempGroupLayer = L.featureGroup(tempGroup);
              //add group to the fgb laer control 
              fgbLayerControl.addOverlay(tempGroupLayer , fgb_name); 
              //add it to the snow control too for later (only used when snow selector is active)
              snowFGBLayerControl.addOverlay(tempGroupLayer , fgb_name); 
              //add it to the soil moisture control too for later (only used when soil moisture selector is active)
              //soilMoistureFGBLayerControl.addOverlay(tempGroupLayer , fgb_name); 
              //display if display param == true on initial load
                if(display == true){
                  tempGroupLayer.addTo(map)
                }
            }
        };
        
        //define exists function
        function exists(data){
          data !== null && data !== undefined
        }

        var cleanUp = function(){
          //remove active layers from map
          activeLayers.eachLayer(function(layer) { map.removeLayer(layer);});
          //remove hypsomeswe from map if loaded
          snowLayers.eachLayer(function(layer) { map.removeLayer(layer);});
          //remove soil moisture from map if loaded
          soilMoistureLayers.eachLayer(function(layer) { map.removeLayer(layer);});
          //remove old layer control
          map.removeControl(layerControl);
          //remove old legend
          map.removeControl(legend);
          map.removeControl(pointLegend);
          map.removeControl(topofire_legend);
          map.removeControl(smap_legend)
          //$("#opacitySlide").val(0.9);
        }

        var updateFgbControls = function(){
          //remove old FGB control 
          map.removeControl(snowFGBLayerControl);
          map.removeControl(soilMoistureFGBLayerControl);
          map.addControl(fgbLayerControl);
        }

        soilMoistureFGBLayerControl.addBaseLayer(L.featureGroup() , '(e) None'); 

        // add FGBs to map (before selector change!!)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/states.fgb', fgb_name = 'States', weight = 3, display = true, popup_property = null);
        //add watersheds and hypsome-swe (only added to snow control) from same fgb to reduce network payload
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/watersheds.fgb', fgb_name = 'Watersheds', weight = 1, display = false, popup_property = 'NAME');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/counties.fgb', fgb_name = 'Counties', weight = 1, display = false, popup_property = 'COUNTY');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/tribal.fgb', fgb_name = 'Tribal Lands', weight = 1, display = false, popup_property = 'NAME');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_usdm.fgb', fgb_name = 'USDM', weight = 1, display = false, popup_property = 'DM');
        //add SNOTEL SWE (only added to snow control)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_snotel.fgb', fgb_name = 'SNOTEL SWE', weight = 1, display = false, popup_property = 'NAME');
        //add soil Moisture Anomolies from Mesonet (only added to soil moisture control)
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_soil_moisture_anom_04in.fgb', fgb_name = '(a) MT Mesonet Soil Moisture (4in)', weight = 1, display = false, popup_property = 'NAME', depth = '4in');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_soil_moisture_anom_08in.fgb', fgb_name = '(b) MT Mesonet Soil Moisture (8in)', weight = 1, display = false, popup_property = 'NAME', depth = '8in');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_soil_moisture_anom_20in.fgb', fgb_name = '(c) MT Mesonet Soil Moisture (20in)', weight = 1, display = false, popup_property = 'NAME', depth = '20in');
        addFGB('https://data.climate.umt.edu/drought-indicators/fgb/current_soil_moisture_anom_36in.fgb', fgb_name = '(d) MT Mesonet Soil Moisture (36in)', weight = 1, display = false, popup_property = 'NAME', depth = '36in');

        //build USDM legend
        USDMlegend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>U.S. Drought Monitor<br>(USDM)<br>"+loadFile('https://data.climate.umt.edu/drought-indicators/fgb/usdm_time.txt')+"</h4>";
              div.innerHTML += '<i style="background: #FFFF00"></i><span>D0 (Abnormally Dry)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>D1 (Moderate Drought)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>D2 (Severe Drought)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>D3 (Extreme Drought)</span><br>';
              div.innerHTML += '<i style="background: #730000"></i><span>D4 (Exceptional Drought)</span><br>';
              return div;
            };

        //add event handler to toggle USDM legend and slider when displayed
        map.on('overlayadd', function(eventLayer){
            if (eventLayer.name === 'USDM'){
              map.addControl(USDMlegend);
              $(".rangesliderUSDM").show()    
            } 
        })
        map.on('overlayremove', function(eventLayer){
            if (eventLayer.name === 'USDM'){
                map.removeControl(USDMlegend);
                $(".rangesliderUSDM").hide()
            } 
        })
        //map opacity function
        function updateOpacity(value) {
          var rangeInput = document.getElementById("opacitySlide").value
          //activeBase.setOpacity(rangeInput)
          activeLayers.eachLayer(function(layer) { layer.setOpacity(rangeInput)});
        }
        //map opacity event listener
        document.getElementById("opacitySlide").addEventListener ("change", updateOpacity, false);

        //USDM opacity fucnction
        function updateOpacityUSDM(value) {
          var rangeInputUSDM = document.getElementById("opacitySlideUSDM").value
          //activeBase.setOpacity(rangeInput)
          USDMLayer.eachLayer(function(layer) { layer.setStyle({fillOpacity: rangeInputUSDM, opacity: rangeInputUSDM})});
        }
        //USDM opacity event listener
        document.getElementById("opacitySlideUSDM").addEventListener ("change", updateOpacityUSDM, false);

        // legend for soil moisture points
        function getColor(d) {
            return d === '<-2 (D4)'  ? "#730000" :
                  d === '-2 - -1.6 (D3)'  ? "#E60000" :
                  d === '-1.6 - -1.3 (D2)' ? "#FFAA00" :
                  d === '-1.3 - -0.8 (D1)' ? "#FCD37F" :
                  d === '-0.8 - -0.5 (D0)' ? "#FFFF00" :
                  d === '-0.5 - 0.5' ? "#FFFFFF" :
                  d === '0.5 - 0.8' ? "#82FCF9" :
                  d === '0.8 - 1.3' ? "#32E1FA" :
                  d === '1.3 - 1.6' ? "#325CFE" :
                  d === '1.6 - 2' ? "#4030E3" :
                  d === '>2' ? "#303B83" :
                                "#000000";
        }
        function style(feature) {
            return {
                weight: 1.5,
                opacity: 1,
                fillOpacity: 1,
                radius: 6,
                fillColor: getColor(feature.properties.TypeOfIssue),
                color: "grey"

            };
        }

        var pointLegend = L.control({position: 'topright'});
        pointLegend.onAdd = function (map) {

        var div = L.DomUtil.create('div', 'info pointLegend');
        labels = ['<h4>Soil Moisture<br>Anomaly (Stations)</h4>'],
        categories = ['<-2 (D4)','-2 - -1.6 (D3)','-1.6 - -1.3 (D2)','-1.3 - -0.8 (D1)',
                      '-0.8 - -0.5 (D0)', '-0.5 - 0.5', '0.5 - 0.8', '0.8 - 1.3',
                      '1.6 - 2', '>2', 'Anomaly N/A<br>Note: Click on points<br>for real time data.'];

        for (var i = 0; i < categories.length; i++) {

                div.innerHTML += 
                labels.push(
                    '<i class="circle" style="background:' + getColor(categories[i]) + '"></i> ' +
                (categories[i] ? categories[i] : '+'));

            }
            div.innerHTML = labels.join('<br>');
        return div;
        }; 

        //function to add soil moisture data
        var addSoilMoisturePoints = function(){
            //add soil moisture legend
            pointLegend.addTo(map);
            map.addControl(soilMoistureFGBLayerControl);
            map.addLayer(soilMoistureLayers._layers['Mesonet VWC4in']);
        }

        document.getElementById ("addSoilMoisturePoints").addEventListener ("click", addSoilMoisturePoints, false);

        //function to call when selector is choosen
        $('select').change(function() {
          if(this.value === 'Choose a Variable'){
            updateFgbControls()
            cleanUp()
          }
          if(this.value === 'SPI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'SPI'
            var variable_lower = 'spi'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spi/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(f) 2 Year SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year SPI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date SPI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'SPEI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'SPEI'
            var variable_lower = 'spei'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/spei/time.txt')
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day SPEI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(f) 2 Year SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year SPEI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date SPEI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'EDDI'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'EDDI'
            var variable_lower = 'eddi'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/eddi/time.txt')
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83'].reverse()).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_15.tif", 
              "(a) 15 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_30.tif", 
              "(b) 30 Day EDDI", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_60.tif", 
              "(c) 60 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_90.tif", 
              "(d) 90 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_180.tif", 
              "(e) 180 Day EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_365.tif", 
              "(f) 1 Year EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_730.tif", 
              "(f) 2 Year EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_water_year.tif", 
              "(h) Water Year EDDI", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_"+variable_lower+"_year_to_date.tif", 
              "(i) Year to Date EDDI", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>>2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>1.6 - 1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>1.3 - 0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>0.8 - 0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>-0.5 - -0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>-0.8 - -1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>-1.3 - -1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>-1.6 - -2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span><-2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Precipitation Percentiles'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'Precipitation<br>Percentiles'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/precipitation/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_15.tif", 
              "(a) 15 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_30.tif", 
              "(b) 30 Day Percentile", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_60.tif", 
              "(c) 60 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_90.tif", 
              "(d) 90 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_180.tif", 
              "(e) 180 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_365.tif", 
              "(f) 1 Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_water_year.tif", 
              "(h) Water Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percentile_year_to_date.tif", 
              "(i) Year to Date Percentile", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>0 - 2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 5 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>5 - 10 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>10 - 20 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>20 - 30 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>70 - 80</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>80 - 90</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>90 - 95</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>95 - 98</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>98 - 100</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Precipitation Percent of Normal'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'Precipitation<br>% of Normal'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/precipitation/time.txt')
            //define breaks
            var breaks = [-999, 5, 25, 50, 70, 90, 110, 130, 150, 200, 400, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#543005", "#8C510A", "#BF812D", "#DFC27D", "#F6E8C3", "#FFFFFF", '#C7EAE5', '#80CDC1', '#35978F', '#01665E', '#003C30']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_15.tif", 
              "(a) 15 Day % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_30.tif", 
              "(b) 30 Day % of Normal", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_60.tif", 
              "(c) 60 Day % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_90.tif", 
              "(d) 90 Day % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_180.tif", 
              "(e) 180 Day % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_365.tif", 
              "(f) 1 Year % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_water_year.tif", 
              "(h) Water Year % of Normal", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/precipitation_current_percent_of_normal_year_to_date.tif", 
              "(i) Year to Date % of Normal", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #543005"></i><span>0 - 5</span><br>';
              div.innerHTML += '<i style="background: #8C510A"></i><span>5 - 25</span><br>';
              div.innerHTML += '<i style="background: #BF812D"></i><span>25 - 50</span><br>';
              div.innerHTML += '<i style="background: #DFC27D"></i><span>50 - 70</span><br>';
              div.innerHTML += '<i style="background: #F6E8C3"></i><span>70 - 90</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>90 - 110</span><br>';
              div.innerHTML += '<i style="background: #C7EAE5"></i><span>110 - 130</span><br>';
              div.innerHTML += '<i style="background: #80CDC1"></i><span>130 - 150</span><br>';
              div.innerHTML += '<i style="background: #35978F"></i><span>150 - 200</span><br>';
              div.innerHTML += '<i style="background: #01665E"></i><span>200 - 400</span><br>';
              div.innerHTML += '<i style="background: #003C30"></i><span>400 - 800</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Temperature Percentiles'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'Temperature<br>Percentiles'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/temperature/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83'].reverse()).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_15.tif", 
              "(a) 15 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_30.tif", 
              "(b) 30 Day Percentile", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_60.tif", 
              "(c) 60 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_90.tif", 
              "(d) 90 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_180.tif", 
              "(e) 180 Day Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_365.tif", 
              "(f) 1 Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_water_year.tif", 
              "(h) Water Year Percentile", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/temperature_current_percentile_year_to_date.tif", 
              "(i) Year to Date Percentile", display = false, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #303B83"></i><span>0 - 2</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>2 - 5</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>5 - 10</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>10 - 20</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>20 - 30</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>70 - 80 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>80 - 90 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>90 - 95 (D2)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>95 - 98 (D3)</span><br>';
              div.innerHTML += '<i style="background: #730000"></i><span>98 - 100 (D4)</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Snowpack'){
            //remove old FGB controls (special case, otherwise use updateFgbControls())
            map.removeControl(fgbLayerControl);
            map.removeControl(soilMoistureFGBLayerControl);
            //add snow controls
            map.addControl(snowFGBLayerControl);
            //define variable of interest
            var variable = 'Standardized<br>Snow Water<br>Equivalent (SWE)'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/snodas/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_snodas_swe_standardized.tif", 
              "(a) Standardized SWE", display = true, breaks = breaks, scale = scale)
            //add hypsome-swe to the map
            map.addLayer(snowLayers._layers['Hypsome-SWE']);
            //add SNOTEL to map
            map.addLayer(snowLayers._layers['SNOTEL SWE']);
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'Soil Moisture'){
            //remove old FGB controls (special case, otherwise use updateFgbControls())
            map.removeControl(fgbLayerControl);
            map.removeControl(snowFGBLayerControl);
            map.addControl(fgbLayerControl);
            
            //define variable of interest
            var variable = 'Soil Moisture'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            topofire_legend = L.control({ position: "bottomleft" });
            smap_legend = L.control({ position: "bottomleft" });
            //define time
            var topofire_time = loadFile('https://data.climate.umt.edu/drought-indicators/topofire/time.txt')
            var smap_time = loadFile('https://data.climate.umt.edu/drought-indicators/smap/time.txt')
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/topofire_soil_moisture_anom.tif", 
              "(a) Topofire Soil Moisture", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current_smap_anom.tif", 
              "(b) SMAP Root-Zone Soil Moisture", display = false, breaks = breaks, scale = scale)
            //add soil moisture point data
            //addSoilMoisturePoints()

            //populate the legend
            topofire_legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+topofire_time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };

            //populate the legend
            smap_legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+smap_time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            //legend.addTo(map);
            //change legend based on layer selected
            map.on('baselayerchange', function (e) {
              if(e.name == '(a) Topofire Soil Moisture')
                {map.removeControl(smap_legend);
                  topofire_legend.addTo(map)};
              if(e.name == '(b) SMAP Root-Zone Soil Moisture')
                {map.removeControl(topofire_legend);
                  smap_legend.addTo(map)};
            });

          }
          if(this.value === 'GRACE Groundwater'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'GRACE<br>Groundwater'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/grace/time.txt')
            //define breaks
            var breaks = [-999, 2, 5, 10, 20, 30, 70, 80, 90, 95, 98, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/current-grace-groundwater-drought.tif", 
              "(a) GRACE Groundwater", display = true, breaks = breaks, scale = scale)
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span>0 - 2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>2 - 5 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>5 - 10 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>10 - 20 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>20 - 30 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>30 - 70</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>70 - 80</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>80 - 90</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>90 - 95</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>95 - 98</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>98 - 100</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
          if(this.value === 'NDVI Anomaly'){
            //update FGB controls 
            updateFgbControls()
            //define variable of interest
            var variable = 'NDVI Anomaly'
            //remove active layers from map and legend
            cleanUp()
            //clear the active layers group to repopulate
            activeLayers = new L.LayerGroup();
            //create new layer control and add it to the map
            layerControl = L.control.layers(null, null, {position: 'topleft', sortLayers: true, collapsed: false}).addTo(map);
            //create new legend "contol" object
            legend = L.control({ position: "bottomleft" });
            //define time
            var time = loadFile('https://data.climate.umt.edu/drought-indicators/ndvi/anom/time.txt')
            // import and add COGs to map from remote server
            //define breaks
            var breaks = [-999, -2.0, -1.6, -1.3, -0.8, -0.5, 0.5, 0.8, 1.3, 1.6, 2, 999].map(function(x) { return x * scaler; });
            //add chroma scale that matches the USDM<div class="div-wrapper">
            var scale = chroma.scale(["#730000", "#E60000", "#FFAA00", "#FCD37F", "#FFFF00", "#FFFFFF", '#82FCF9', '#32E1FA', '#325CFE', '#4030E3', '#303B83']).classes(breaks); 
            // add COGS
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_7.tif", 
              "(a) 7 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_15.tif", 
              "(b) 15 Day NDVI Anomaly", display = true, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_30.tif", 
              "(c) 30 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_60.tif", 
              "(d) 60 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            addCOG("https://data.climate.umt.edu/drought-indicators/cog/ndvi_anom_90.tif", 
              "(e) 90 Day NDVI Anomaly", display = false, breaks = breaks, scale = scale)
            
            //populate the legend
            legend.onAdd = function(map) {
              var div = L.DomUtil.create("div", "legend");
              div.innerHTML += "<h4>"+variable+"<br>"+time+"</h4>";
              div.innerHTML += '<i style="background: #730000"></i><span><-2 (D4)</span><br>';
              div.innerHTML += '<i style="background: #E60000"></i><span>-2 - -1.6 (D3)</span><br>';
              div.innerHTML += '<i style="background: #FFAA00"></i><span>-1.6 - -1.3 (D2)</span><br>';
              div.innerHTML += '<i style="background: #FCD37F"></i><span>-1.3 - -0.8 (D1)</span><br>';
              div.innerHTML += '<i style="background: #FFFF00"></i><span>-0.8 - -0.5 (D0)</span><br>';
              div.innerHTML += '<i style="background: #FFFFFF"></i><span>-0.5 - 0.5</span><br>';
              div.innerHTML += '<i style="background: #82FCF9"></i><span>0.5 - 0.8</span><br>';
              div.innerHTML += '<i style="background: #32E1FA"></i><span>0.8 - 1.3</span><br>';
              div.innerHTML += '<i style="background: #325CFE"></i><span>1.3 - 1.6</span><br>';
              div.innerHTML += '<i style="background: #4030E3"></i><span>1.6 - 2</span><br>';
              div.innerHTML += '<i style="background: #303B83"></i><span>>2</span><br>';
              return div;
            };
            //add to map
            legend.addTo(map);
            //fin
          }
        });
      });
    </script>
    <!-- Add footer image of logos -->
    <div class="parent">
      <div class="child">
        <img src="./misc_content/logos.webp" height="220px" align="bottom"/>
      </div>
    </div>
    <hr>
    <!-- Footer -->
    <footer>
      <p style="text-align: center;">Produced by the <a href="https://climate.umt.edu/">Montana Climate Office</a></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>Montana Forest & Conservation Experiment Station</em></span></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>University of Montana</em></span></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>32 Campus Drive</em></span></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>Missoula, MT 59812</em></span></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>Phone: (406) 243-6793</em></span></p>
      <p style="text-align: center;"><span style="color: #808080;"><em>state.climatologist@umontana.edu</em></span></p>
    </footer>
  </body>
</html>
